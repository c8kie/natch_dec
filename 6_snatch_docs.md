<div style="page-break-before:always;">
</div>

# <a name="snatch"></a>6. Графический интерфейс для анализа SNatch

*SNatch* – это инструмент с графическим интерфейсом, предназначенный для постобработки и отображения данных, полученных от инструмента *Natch*. Работать с этим интерфейсом можно через браузер.

## 6.1. Системные требования

Тестирование инструмента проводилось на ОС Ubuntu 20.04 и Ubuntu 22.04. В качестве браузеров использовались Google Chrome версии 105.0.5148.2 и выше и Mozilla Firefox версии 101.0 и выше.

Необходимые для функционирования *SNatch* пакеты будут автоматически установлены в ходе первоначальной настройки.

## 6.2. Настройка и запуск

Для работы графического интерфейса *SNatch* необходимо подготовить окружение, а именно установить ряд пакетов для Ubuntu и Python, а также создать базу данных. Все это делается автоматически с помощью скрипта *snatch_setup.sh*. Для установки потребуется пароль для sudo. **Важно! Запускать скрипт под sudo не нужно, дождитесь запроса пароля.** Пакеты для Python устанавливаются в виртуальную среду, таким образом пакеты на вашей машине не будут переустанавливаться и конфликтовать. Процесс займет некоторое время, запускать скрипт нужно только при первом использовании. Кроме того, повторный запуск скрипта приведет к удалению базы данных.

Помимо скрипта для настройки окружения в пакет поставки входят скрипты *snatch_run.sh* и *snatch_stop.sh* для запуска и остановки *SNatch* соответственно. Скрипт *snatch_run.sh* запускает необходимые для работы службы, а также открывает браузер с интерфейсом. В терминал, из которого был запущен скрипт, будут приходить сообщения от сервера, однако, он свободен для использования, поэтому по окончании работы из него же можно запустить скрипт *snatch_stop.sh* для остановки служб. Запускать *snatch_stop.sh* следует всегда, в противном случае процессы останутся висеть в памяти вашего компьютера до перезагрузки.

Все скрипты для *SNatch* можно запускать из любого расположения. Если по какой-то причине при запуске
*snatch_run.sh* страница в браузере не загрузилась, но при этом службы запустились, следует обновить страницу.

После выполнения скрипта *snatch_run.sh* в этом же терминале начнут выводится информационные сообщения о работе *SNatch* и сообщения о возникающих ошибках. Полученные сообщения можно использовать для отслеживания внутреннего процесса работы *SNatch* и в качестве данных при формировании обращений об обнаруженных багах.

## 6.3. Работа со *SNatch*

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_main_ui.png><figcaption>_Окно SNatch_</figcaption>

На данном рисунке показано окно *SNatch*, где цифрами обозначены основные элементы интерфейса:

1. Кнопка для повторной загрузки архива с поверхностью атаки. При нажатии на эту кнопку информация в текущем проекте будет стерта, вкладки закрыты, и будет запущена новая обработка переданного архива.
2. Кнопки генерации дополнительных графов. Граф вызовов и флейм граф не строятся автоматически при создании проекта. Для их генерации необходимо нажать на соответствующие кнопки. После нажатия на кнопке появится индикатор загрузки. По завершении процесса кнопка исчезнет, а соответствующий пункт в меню станет активным.
3. Меню проекта. Содержит в себе список сгенерированных на основании загруженного архива графов и деревьев (таких как: граф процессов, дерево процессов, граф вызовов и т.д.)
4. Всплывающие меню для взаимодействия с проектами (создание нового, открытие существующих и удаление существующих)
5. Кнопка открытия меню взаимодействия с проектами
6. Название открытого проекта
7. Открытые вкладки с содержимым (таким как: граф вызовов, граф процессов)
8. Окно отображения содержимого

### 6.3.1. Создание проекта

Для создания нового проекта необходимо нажатием на (6) открыть меню проектов и выбрать *New project...*. Для переключения между существующим проектами необходимо из меню проектов в списке *Existing projects:* выбрать название интересующего проекта. Для удаления проекта достаточно в списке проектов нажать на кнопку *del* рядом с именем удаляемого проекта.

При нажатии на (1) в уже открытом проекте пользователю будет предложено выбрать новый архив (данный архив получается в результате работы *Natch*), после чего текущие данные в проекте будут стёрты и заменены полученными в результате обработки предоставленного файла.

При создании нового проекта происходит открытие модального окна:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_new_proj_modal.png><figcaption>_Создание проекта_</figcaption>

В данном окне пользователь может ввести имя нового проекта в соответствующее поле *Project name*,
а также выбрать архив поверхности атаки в *Choose surface file* (данный архив получается в результате работы *Natch*). Если оба поля заполнены, то становится активна кнопка *Create*, по нажатию на которую происходит закрытие данного модального окна, создание нового проекта, автоматическое переключение на него и запуск процесса обработки архива. При нажатии на кнопку *Close* происходит закрытие модального окна.

Рекомендуется не осуществлять создание нового проекта, если не завершился процесс создания текущего.

Во время обработки архива поверхности атаки в верхней части экрана появляется шкала прогресса следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_progressbar.png><figcaption>_Шкала прогресса_</figcaption>

В процессе обработки текст, сопровождающий шкалу прогресса, будет изменяться таким образом, чтобы оповещать об актуальном статусе выполняемой задачи. Нажатие на кнопку *Abort* аварийно прерывает процесс обработки. Проект при этом следует удалить самостоятельно.

### 6.3.2. Граф вызовов

В процессе первоначальной обработки архива поверхности атаки граф вызовов не создаётся. Чтобы граф вызовов появился в проекте, необходимо нажать на кнопку *Generate* рядом с соответствующим пунктом в меню проекта. По завершении процесса генерации в боковом меню проекта под пунктом *Additional graphs* станет активным пункт *call-graph*. Для открытия графа вызовов достаточно нажать на данный пункт в меню. После открытия появится новая вкладка с соответствующим названием, а в окне отображения содержимого откроется граф, представленный в виде древовидной структуры:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_call_graph.png><figcaption>_Граф вызовов_</figcaption>

В данном окне представлены следующие элементы:

1. Чекбоксы опций. *Hide symbolless graphs* прячет из отображаемого графа деревья, не содержащие распознанных символов; *Full modules path* задаёт формат отображения имен модулей на графе: сокращенный, либо полный путь.
2. Элементы управления графом. Первая кнопка (три горизонтальные черты) раскрывает все ветви графа, содержащие символы; повторное нажатие этой кнопки сворачивает весь граф. Нажатие на кнопки +/- рядом с веткой раскрывает/сворачивает данную ветку в дереве.
3. Содержимое графа. В корне дерева отображается имя процесса, к которому относится данный граф вызовов. Каждый узел дерева содержит имя вызванной функции (адрес смещения в модуле, при отсутствии символьной информации), путь к файлу исходного кода и строка в файле, относящаяся к началу функции, имя модуля. Синим цветом выделяются функции непосредственно взаимодействовавшие с помеченными данными. При наведении курсора на "синие" функции возникает всплывающая подсказка, содержащая номера строк в исходниках, где происходило взаимодействие с помеченными данным.

### 6.3.3. Флейм граф

В процессе первоначальной обработки архива поверхности атаки флейм граф не создаётся. По аналогии с графом вызовов необходимо нажать на кнопку *Generate* и по завершении вызвать флейм граф нажатием на пункт в меню проекта. В открывшейся вкладке будет показан флейм граф следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_flame_graph.png><figcaption>_Флейм граф_</figcaption>

В данном окне представлены следующие элементы:

1. Выпадающий список построенных флейм графов, сгрупированный по процессам. Графы, относящиеся к пользовательским потокам, помечены словом *user*, выполнявшиеся ядром – *kernel*. При нажатии на пункт списка произойдет открытие соответствующего флейм графа.
2. Кнопки навигации по флейм графу. Используются для перемещения между функциями, работавшими с помеченными данными. Нажатие на кнопку *вперед* делает активным следующую такую функцию, *назад* – предыдущую, а *Reset zoom* сбрасывает граф к исходному состоянию (активным становится корневой блок)
3. Список функций, работавших с помченными данными. В данном списке показано имя функции (либо смещение относительно модуля, в отсутствии символьной информации) и продолжительность работы функции (синим цветом) в айкаунтах. При нажатии на пункт в этом списке, соответствующая функция на флейм графе становится активной.
4. Флейм граф. В верхней части показано имя открытого флейм графа. При нажатии на любой блок флейм графа он становится активным, т.е. занимает 100% ширины графа, с соответствующим расширением дочерних блоков. Синим цветом на флейм графе отображаются функции, взаимодействовавшие с помеченными данными. При наведении курсора на "синие" функции возникает всплывающая подсказка, содержащая адреса в исходниках, где происходило взаимодействие с помеченными данными.

### 6.3.4. Граф процессов

В меню графа процессов есть два пункта: *Process-graph* и *Process-graph content* (json представление графа). После выбора одного из этих пунктов открывается новая вкладка с соответствующим названием. Для *Process-graph content* содержимое вкладки будет представлено текстом, а для *Process-graph* откроется вкладка следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_process_graph.png><figcaption>_Граф процессов_</figcaption>

В данном окне представлены следующие элементы:

1. Шкала выбора активного шага выполнения. Перемещение по данной шкале соответствующим образом изменяет отображаемый граф.
2. Выбор режима отображения графа. Граф процессов поддерживает 4 режима отображения: 
  * *Active* – отображаются элементы (узлы и стрелки), которые задействованы на текущем шаге;
  * *Past* – отображаются элементы, которые задействованы на текущем шаге, а также те, которые произошли в прошлом (узлы и стрелки серого цвета);
  * *Significant* – отображаются элементы, которые задействованы на текущем шаге, а также те узлы, которые были задействованы в прошлом и при этом еще будут задействованы в будущем, и прошедшие стрелки между ними (узлы и стрелки бледных цветов);
  * *All* – отображаются элементы, которые задействованы на текущем шаге, а также те узлы (но не стрелки), которые вообще существуют на схеме (узлы бледных цветов).
3. Легенда графа. Описывает набор отображаемых на графе узлов и их внешний вид.
4. Граф процессов. Интерактивный граф, отображающий взаимодействие процессов, работавших с помеченными данными. Расположение узлов на графе можно изменять удобным для пользователя образом. При двойном нажатии на узел в данном графе произойдет открытие новой вкладки с отображением графа модулей для выбранного процесса. При наличии информации о контейнерах, таковые будут отображены на графе в виде зеленых блоков, содержащих соответствующие им процессы.

### 6.3.5. Граф модулей

В меню графа процессов есть два пункта: *Module-graph* и *Module-graph content* (json представление графа). После выбора одного из этих пунктов открывается новая вкладка с соответствующим названием. Для *Module-graph content* содержимое вкладки будет представлено текстом, а для *Module-graph* откроется вкладка следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_module_graph.png><figcaption>_Граф модулей_</figcaption>

В данном окне представлены следующие элементы:

1. Шкала выбора активного шага выполнения. Перемещение по данной шкале соответствующим образом изменяет отображаемый граф.
2. Легенда графа. Описывает набор отображаемых на графе узлов и их внешний вид.
3. Граф модулей. Интерактивный граф, отображающий взаимодействие модулей, работавших с помеченными данными. Расположение узлов на графе можно изменять удобным для пользователя образом. Стрелки, описывающие взаимодействие, сопровождаются номером, соответствующим очередности взаимодействия. Номер с *(звездочкой) означает, что на данном шаге между модулями было более одного взаимодействия.

### 6.3.6. Временной граф процессов

Для открытия временного графа процессов необходимо вызвать из меню проекта пункт *Process-timeline*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_process_timeline.png><figcaption>_Временной граф процессов_</figcaption>

В данном окне представлены следующие элементы:

1. Набор фильтров отображаемой информации. При установленной галочке *Kernel* на графе будут отображаться процессы уровня ядра; при галочке *Container* будут отображаться служебные процессы функционирования контейнеров (на данный момент docker).
2. Временной граф процессов. Представляет собой граф, где горизонтальная ось отображает время выполнения процесса, от его начала и до завершения. Граф поддерживает изменение масштабов по временной оси с помощью колесика мыши. Синим цветом на графе показаны процессы, в которых происходило взаимодействие с помеченными данными. При наведении на процесс появляется всплывающая подсказка со следующей информацией о процессе (не для всех процессов доступен полный набор информации): имя процесса, pid, путь к исполняемому файлу, исполняемая команда, родительские процессы, список процессов-потомков. При двойном нажатии на процесс происходит открытие новой вкладки с графом процессов на шаге, соответствующем началу работы данного процесса.

### 6.3.7. Дерево процессов

Для открытия дерева процессов необходимо вызвать из меню проекта пункт *Process-tree*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_process_tree.png><figcaption>_Дерево процессов_</figcaption>

На дереве процессов показано отношение между процессами в формате "родитель-потомок", при этом процессы непосредственно взаимодействовавшие с помеченными данными выделены синим цветом. Ярко-розовым цветом выделены процессы, запущенные с правами root и работавшие с помеченными данными, а бледно-розовым - просто запущенные от root. Помимо имени процесса на графе также отображается команда, которой он был запущен (при наличии).

## 6.4. Список горячих клавиш

### 6.4.1. Общие комбинации

- *Ctrl+Alt+N* – вызывает модальное окно создания нового проекта
- *Ctrl+Alt+G* – запускает одновременную генерацию флейм графа и графа вызовов
- *Ctrl+Alt+C* – открывает граф вызовов (при наличии)
- *Ctrl+Alt+F* – открывает флейм граф (при наличии)
- *Ctrl+Alt+P* – открывает граф процессов
- *Ctrl+Alt+M* – открывает граф модулей
- *Ctrl+Alt+L* – открывает временной граф процессов
- *Ctrl+Alt+R* – открывает дерево процессов
- *Ctrl+X* – закрывает текущую вкладку в окне *SNatch*
- *Shift+Tab* – выбирает следующую открытую вкладку в окне *SNatch*

### 6.4.2. Управление интерактивными элементами вкладок

Флейм граф:

- *→* – переход к следующей помеченной функции
- *←* – переход к предыдущей помеченной функции
- *Ctrl+↓* – сброс состояния flame графа

Граф процессов:

- *→* – переход к следующему шагу
- *←* – переход к предыдущему шагу
- *Ctrl+→* – переход к последнему шагу
- *Ctrl+←* – переход к первому шагу
- *Ctrl+↓* – выбор предыдущего режима отображения
- *Ctrl+↑* – выбор следующего режима отображения

Граф модулей:

- *→* – переход к следующему шагу
- *←* – переход к предыдущему шагу
- *Ctrl+→* – переход к последнему шагу
- *Ctrl+←* – переход к первому шагу
